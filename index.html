<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 800px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: #4a5568;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .username-section {
            padding: 20px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .username-section input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .username-section input:focus {
            outline: none;
            border-color: #667eea;
        }

        .username-section button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .username-section button:hover {
            background: #5a67d8;
        }

        .username-section button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f7fafc;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.own {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.other {
            background: #e2e8f0;
            color: #2d3748;
        }

        .message-info {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .message-content {
            font-size: 16px;
        }

        .input-section {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .input-section input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-section input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-section button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .input-section button:hover {
            background: #5a67d8;
        }

        .input-section button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .status {
            padding: 10px 20px;
            text-align: center;
            font-size: 14px;
            background: #fed7d7;
            color: #c53030;
        }

        .status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            ğŸ’¬ èŠå¤©å®¤
        </div>
        
        <div class="username-section" id="usernameSection">
            <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å" maxlength="20">
            <button id="connectBtn">è¿æ¥</button>
        </div>
        
        <div class="status" id="status">è¯·è¾“å…¥ç”¨æˆ·åå¹¶è¿æ¥åˆ°èŠå¤©å®¤</div>
        
        <div class="messages-container" id="messagesContainer">
            <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        
        <div class="input-section hidden" id="inputSection">
            <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500">
            <button id="sendBtn">å‘é€</button>
        </div>
    </div>

    <script>
        let ws = null;
        let username = '';
        let isConnected = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectInterval = 3000; // 3ç§’åé‡è¿

        const usernameSection = document.getElementById('usernameSection');
        const usernameInput = document.getElementById('usernameInput');
        const connectBtn = document.getElementById('connectBtn');
        const status = document.getElementById('status');
        const messagesContainer = document.getElementById('messagesContainer');
        const inputSection = document.getElementById('inputSection');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        // è¿æ¥WebSocket
        function connect() {
            username = usernameInput.value.trim();
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }

            const wsUrl = `ws://${window.location.host}/ws`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                isConnected = true;
                updateStatus('å·²è¿æ¥åˆ°èŠå¤©å®¤', true);
                
                // å‘é€ç”¨æˆ·åä½œä¸ºèº«ä»½æ ‡è¯†
                ws.send(username);
                
                // éšè—ç”¨æˆ·åè¾“å…¥åŒºåŸŸï¼Œæ˜¾ç¤ºæ¶ˆæ¯è¾“å…¥åŒºåŸŸ
                usernameSection.classList.add('hidden');
                inputSection.classList.remove('hidden');
                
                // èšç„¦åˆ°æ¶ˆæ¯è¾“å…¥æ¡†
                messageInput.focus();
                
                // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                addMessage('ç³»ç»Ÿ', `æ¬¢è¿ ${username} åŠ å…¥èŠå¤©å®¤ï¼`, 'system');
            };

            ws.onmessage = function(event) {
                console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
                // åç«¯å¹¿æ’­çš„æ¶ˆæ¯æ ¼å¼ä¸º "ç”¨æˆ·å:æ¶ˆæ¯å†…å®¹"
                const colonIndex = event.data.indexOf(':');
                if (colonIndex > 0) {
                    const senderName = event.data.substring(0, colonIndex);
                    const messageContent = event.data.substring(colonIndex + 1);
                    
                    // åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯
                    if (senderName === username) {
                        // ä¸æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯ï¼Œå› ä¸ºå·²ç»åœ¨æœ¬åœ°æ˜¾ç¤ºäº†
                        return;
                    } else {
                        // æ˜¾ç¤ºå…¶ä»–ç”¨æˆ·çš„æ¶ˆæ¯
                        addMessage(senderName, messageContent, 'other');
                    }
                } else {
                    // å¦‚æœæ ¼å¼ä¸æ­£ç¡®ï¼Œæ˜¾ç¤ºåŸå§‹æ¶ˆæ¯
                    addMessage('æœªçŸ¥ç”¨æˆ·', event.data, 'other');
                }
            };

            // å¤„ç†å¿ƒè·³æ£€æµ‹ - è‡ªåŠ¨å“åº”æœåŠ¡å™¨çš„pingæ¶ˆæ¯
            ws.addEventListener('ping', function() {
                console.log('æ”¶åˆ°pingï¼Œå‘é€pongå“åº”');
                // WebSocketä¼šè‡ªåŠ¨å¤„ç†pongå“åº”ï¼Œæ— éœ€æ‰‹åŠ¨å‘é€
            });

            // é‡ç½®é‡è¿è®¡æ•°å™¨
            reconnectAttempts = 0;

            ws.onclose = function(event) {
                console.log('WebSocketè¿æ¥å·²å…³é—­', event);
                isConnected = false;
                
                // å¦‚æœä¸æ˜¯æ­£å¸¸å…³é—­ä¸”ç”¨æˆ·åå·²è®¾ç½®ï¼Œå°è¯•é‡è¿
                if (event.code !== 1000 && username && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    updateStatus(`è¿æ¥æ–­å¼€ï¼Œ${reconnectInterval/1000}ç§’åå°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})`, false);
                    setTimeout(() => {
                        console.log(`å°è¯•é‡è¿ ${reconnectAttempts}/${maxReconnectAttempts}`);
                        reconnect();
                    }, reconnectInterval);
                } else {
                    updateStatus('è¿æ¥å·²æ–­å¼€', false);
                    // æ˜¾ç¤ºç”¨æˆ·åè¾“å…¥åŒºåŸŸï¼Œéšè—æ¶ˆæ¯è¾“å…¥åŒºåŸŸ
                    usernameSection.classList.remove('hidden');
                    inputSection.classList.add('hidden');
                    reconnectAttempts = 0;
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateStatus('è¿æ¥é”™è¯¯', false);
            };
        }

        // é‡è¿å‡½æ•°
        function reconnect() {
            if (username && reconnectAttempts <= maxReconnectAttempts) {
                const wsUrl = `ws://${window.location.host}/ws`;
                ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    console.log('é‡è¿æˆåŠŸ');
                    isConnected = true;
                    updateStatus('é‡è¿æˆåŠŸ', true);
                    reconnectAttempts = 0;
                    
                    // é‡æ–°å‘é€ç”¨æˆ·å
                    ws.send(username);
                    
                    addMessage('ç³»ç»Ÿ', 'é‡æ–°è¿æ¥æˆåŠŸï¼', 'system');
                };

                ws.onmessage = function(event) {
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
                    const colonIndex = event.data.indexOf(':');
                    if (colonIndex > 0) {
                        const senderName = event.data.substring(0, colonIndex);
                        const messageContent = event.data.substring(colonIndex + 1);
                        
                        if (senderName === username) {
                            return;
                        } else {
                            addMessage(senderName, messageContent, 'other');
                        }
                    } else {
                        addMessage('æœªçŸ¥ç”¨æˆ·', event.data, 'other');
                    }
                };

                ws.addEventListener('ping', function() {
                    console.log('æ”¶åˆ°pingï¼Œå‘é€pongå“åº”');
                });

                ws.onclose = function(event) {
                    console.log('é‡è¿WebSocketè¿æ¥å·²å…³é—­', event);
                    isConnected = false;
                    
                    if (event.code !== 1000 && username && reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        updateStatus(`è¿æ¥æ–­å¼€ï¼Œ${reconnectInterval/1000}ç§’åå°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})`, false);
                        setTimeout(() => {
                            console.log(`å°è¯•é‡è¿ ${reconnectAttempts}/${maxReconnectAttempts}`);
                            reconnect();
                        }, reconnectInterval);
                    } else {
                        updateStatus('è¿æ¥å·²æ–­å¼€', false);
                        usernameSection.classList.remove('hidden');
                        inputSection.classList.add('hidden');
                        reconnectAttempts = 0;
                    }
                };

                ws.onerror = function(error) {
                    console.error('é‡è¿WebSocketé”™è¯¯:', error);
                    updateStatus('é‡è¿å¤±è´¥', false);
                };
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !isConnected) {
                return;
            }

            try {
                // å‘é€çº¯æ–‡æœ¬æ¶ˆæ¯ï¼ˆåç«¯ä¼šå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼‰
                ws.send(message);
                
                // åœ¨æœ¬åœ°æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
                addMessage(username, message, 'own');
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
            } catch (e) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', e);
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(user, message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (type === 'system') {
                messageDiv.innerHTML = `
                    <div class="message-info">${timeString}</div>
                    <div class="message-content">${message}</div>
                `;
                messageDiv.style.background = '#bee3f8';
                messageDiv.style.color = '#2a69ac';
                messageDiv.style.textAlign = 'center';
                messageDiv.style.margin = '0 auto';
            } else {
                messageDiv.innerHTML = `
                    <div class="message-info">${user} - ${timeString}</div>
                    <div class="message-content">${message}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, connected) {
            status.textContent = message;
            status.className = connected ? 'status connected' : 'status';
        }

        // äº‹ä»¶ç›‘å¬å™¨
        connectBtn.addEventListener('click', connect);
        sendBtn.addEventListener('click', sendMessage);

        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connect();
            }
        });

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåèšç„¦åˆ°ç”¨æˆ·åè¾“å…¥æ¡†
        window.addEventListener('load', function() {
            usernameInput.focus();
        });
    </script>
</body>
</html>